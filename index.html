<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flora Sun的AI 單字學習助理</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <script src='https://unpkg.com/tesseract.js@5/dist/tesseract.min.js'></script>
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #f0f4f8; /* 淡藍灰色背景 */
        }
        .app-container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            background-color: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        .view {
            display: none;
        }
        .view.active {
            display: block;
        }
        .btn {
            transition: all 0.3s ease;
            transform: translateY(0);
        }
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        .flashcard {
            perspective: 1000px;
            cursor: pointer;
        }
        .flashcard-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }
        .flashcard.is-flipped .flashcard-inner {
            transform: rotateY(180deg);
        }
        .flashcard-front, .flashcard-back {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 16px;
            background-color: #ffffff;
            border: 2px solid #e2e8f0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .flashcard-back {
            transform: rotateY(180deg);
            background-color: #f8fafc;
        }
        /* 自定義加載動畫 */
        .loader {
            border: 5px solid #f3f3f3;
            border-radius: 50%;
            border-top: 5px solid #3498db;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* 自定義彈出訊息 */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            border-radius: 9999px;
            color: white;
            opacity: 0;
            transition: opacity 0.5s, bottom 0.5s;
            z-index: 999;
        }
        .toast.show {
            opacity: 1;
            bottom: 40px;
        }
        .toast-correct { background-color: #28a745; }
        .toast-wrong { background-color: #dc3545; }
    </style>
</head>
<body class="bg-gray-100">

    <div class="app-container">
        <div id="main-view" class="view active text-center">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">Flora Sun的AI 單字學習助理</h1>
            <p class="text-gray-500 mb-8">透過照片辨識、單字卡與測驗，高效學習英文</p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <button onclick="showView('word-bank-view')" class="btn bg-white border border-gray-300 text-gray-700 p-6 rounded-xl shadow-sm hover:shadow-lg">
                    <h2 class="text-2xl font-semibold mb-2">我的單字庫</h2>
                    <p>管理、新增或匯入您的單字</p>
                </button>
                <button onclick="startFlashcardMode()" class="btn bg-blue-500 text-white p-6 rounded-xl shadow-lg hover:bg-blue-600">
                    <h2 class="text-2xl font-semibold mb-2">單字卡模式</h2>
                    <p>複習已儲存的單字</p>
                </button>
                <button onclick="startQuizMode()" class="btn bg-green-500 text-white p-6 rounded-xl shadow-lg hover:bg-green-600 col-span-1 md:col-span-2">
                    <h2 class="text-2xl font-semibold mb-2">測驗模式</h2>
                    <p>透過聽力拼寫來驗收學習成果</p>
                </button>
            </div>
        </div>

        <div id="word-bank-view" class="view">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold text-gray-800">我的單字庫</h2>
                <button onclick="showView('main-view')" class="btn bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300">返回主選單</button>
            </div>
            
            <div class="bg-gray-50 p-6 rounded-xl border border-gray-200 mb-6">
                <h3 class="text-xl font-semibold mb-4 text-gray-700">新增單字</h3>
                <div class="space-y-3 mb-4">
                    <div class="flex flex-col sm:flex-row gap-3">
                        <input id="manual-word-input" type="text" placeholder="輸入英文單字" class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <button id="translate-manual-btn" onclick="translateAndFillManualInput()" class="btn bg-teal-500 text-white px-6 py-3 rounded-lg hover:bg-teal-600">自動翻譯</button>
                    </div>
                    <div class="flex flex-col sm:flex-row gap-3">
                        <input id="manual-translation-input" type="text" placeholder="自動翻譯結果..." class="flex-grow p-3 border border-gray-300 rounded-lg bg-gray-100 focus:ring-2 focus:ring-blue-500">
                        <button onclick="addWordManually()" class="btn bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600">新增單字</button>
                    </div>
                </div>
                <div class="border-t pt-4">
                    <h4 class="text-lg font-medium text-gray-600 mb-3">或從文字匯入</h4>
                    <textarea id="paste-input" class="w-full p-3 border border-gray-300 rounded-lg h-32 focus:ring-2 focus:ring-purple-500" placeholder="貼上單字列表，一行一個單字，格式如下：&#10;extreme (adj.) 極端的&#10;damage (n.) 損害；毀壞"></textarea>
                    <button onclick="importFromPaste()" class="mt-3 w-full btn bg-purple-500 text-white px-6 py-3 rounded-lg hover:bg-purple-600">匯入單字列表</button>
                </div>
            </div>

            <div class="bg-gray-50 p-6 rounded-xl border border-gray-200 mb-6 text-center">
                 <h3 class="text-xl font-semibold mb-4 text-gray-700">圖片辨識</h3>
                 <label for="image-upload" class="btn bg-indigo-500 text-white px-6 py-3 rounded-lg hover:bg-indigo-600 cursor-pointer inline-block">從圖片辨識單字</label>
                 <input id="image-upload" type="file" class="hidden" accept="image/*" onchange="recognizeWordsFromImage(event)">
                 <p id="ocr-status" class="mt-2 text-sm text-gray-500"></p>
            </div>
            
             <div id="ocr-results-container" class="hidden bg-yellow-50 p-6 rounded-xl border border-yellow-200 mb-6">
                <h3 class="text-xl font-semibold mb-4 text-gray-700">圖片辨識結果</h3>
                <p class="text-sm text-gray-600 mb-4">系統已自動翻譯，請檢查、修改並勾選您想加入的單字。</p>
                <div id="ocr-results" class="space-y-3 max-h-60 overflow-y-auto"></div>
                <div class="mt-4 text-right">
                    <button onclick="addSelectedWordsFromOCR()" class="btn bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600">加入選取的單字</button>
                </div>
            </div>

            <div id="word-list" class="space-y-2 mb-6"></div>
             <div class="text-center border-t pt-6 mt-6">
                <button onclick="openDeleteModal()" class="btn bg-red-100 text-red-700 px-6 py-3 rounded-lg hover:bg-red-200 hover:text-red-800 text-sm font-semibold">
                    刪除整個單字庫
                </button>
            </div>
        </div>

        <div id="flashcard-view" class="view">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold text-gray-800">單字卡模式</h2>
                <button onclick="showView('main-view')" class="btn bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300">返回主選單</button>
            </div>

            <div id="flashcard-container" class="relative h-64 mb-6">
                <div id="flashcard" class="flashcard w-full h-full" onclick="this.classList.toggle('is-flipped')">
                    <div class="flashcard-inner">
                        <div id="flashcard-front" class="flashcard-front">
                            <span id="flashcard-word" class="text-5xl font-bold text-gray-800"></span>
                        </div>
                        <div id="flashcard-back" class="flashcard-back">
                            <span id="flashcard-translation" class="text-4xl font-bold text-gray-700"></span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex justify-center items-center gap-4">
                <button onclick="prevFlashcard()" class="btn bg-gray-500 text-white p-4 rounded-full w-16 h-16 flex items-center justify-center shadow-lg hover:bg-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                </button>
                <button onclick="speakFlashcardWord()" class="btn bg-blue-500 text-white p-4 rounded-full w-20 h-20 flex items-center justify-center shadow-lg hover:bg-blue-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.858 8.464a5 5 0 000 7.072m2.828 9.9A9 9 0 008.686 3.343M9 9l6-6m0 18l-6-6" /></svg>
                </button>
                <button onclick="nextFlashcard()" class="btn bg-gray-500 text-white p-4 rounded-full w-16 h-16 flex items-center justify-center shadow-lg hover:bg-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                </button>
            </div>
             <div id="flashcard-progress" class="text-center mt-4 text-gray-500"></div>
        </div>

        <div id="quiz-view" class="view">
             <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold text-gray-800">測驗模式</h2>
                <button onclick="showView('main-view')" class="btn bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300">返回主選單</button>
            </div>
            <div class="text-center">
                <p class="text-gray-600 mb-4">請聽發音，然後拼出單字</p>
                <button onclick="speakQuizWord()" class="btn bg-blue-500 text-white p-4 rounded-full w-20 h-20 flex items-center justify-center shadow-lg hover:bg-blue-600 mx-auto">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.858 8.464a5 5 0 000 7.072m2.828 9.9A9 9 0 008.686 3.343M9 9l6-6m0 18l-6-6" /></svg>
                </button>
                <input id="quiz-input" type="text" class="mt-6 w-full max-w-md mx-auto p-4 text-2xl text-center border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500" placeholder="在這裡輸入答案..." autocomplete="off">
                <div id="quiz-feedback" class="mt-4 text-xl font-semibold h-8"></div>
                <button id="quiz-submit-btn" onclick="checkQuizAnswer()" class="mt-6 btn bg-green-500 text-white px-12 py-4 rounded-lg text-xl font-bold hover:bg-green-600">送出</button>
            </div>
            <div id="quiz-progress" class="text-center mt-6 text-gray-500"></div>
        </div>

    </div>
    
    <div id="toast-message" class="toast"></div>

    <div id="delete-confirm-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center">
        <div class="relative mx-auto p-6 border w-full max-w-md shadow-lg rounded-2xl bg-white">
            <div class="mt-3 text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                    <svg class="h-6 w-6 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                </div>
                <h3 class="text-xl leading-6 font-bold text-gray-900 mt-4">確認刪除</h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-base text-gray-600">
                        您確定要刪除整個單字庫嗎？<br>此操作將無法復原。
                    </p>
                </div>
                <div class="flex justify-center items-center gap-4 mt-4">
                    <button id="cancel-delete-btn" class="btn px-6 py-3 bg-gray-200 text-gray-800 font-semibold rounded-lg hover:bg-gray-300">
                        取消
                    </button>
                    <button id="confirm-delete-btn" class="btn px-6 py-3 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700">
                        確定刪除
                    </button>
                </div>
            </div>
        </div>
    </div>


    <script>
        // DOM 元素
        const views = document.querySelectorAll('.view');
        const manualWordInput = document.getElementById('manual-word-input');
        const manualTranslationInput = document.getElementById('manual-translation-input');
        const wordList = document.getElementById('word-list');
        const ocrStatus = document.getElementById('ocr-status');
        const ocrResultsContainer = document.getElementById('ocr-results-container');
        const ocrResults = document.getElementById('ocr-results');
        const flashcardWord = document.getElementById('flashcard-word');
        const flashcardTranslation = document.getElementById('flashcard-translation');
        const flashcardProgress = document.getElementById('flashcard-progress');
        const quizInput = document.getElementById('quiz-input');
        const quizFeedback = document.getElementById('quiz-feedback');
        const quizProgress = document.getElementById('quiz-progress');
        const quizSubmitBtn = document.getElementById('quiz-submit-btn');
        const toastMessage = document.getElementById('toast-message');
        const deleteConfirmModal = document.getElementById('delete-confirm-modal');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');

        // 全域變數和應用程式狀態
        let webAppUrl = 'https://script.google.com/macros/s/AKfycbzxnwAMkrpZ2T5BWH0bbNfLo0WfbWe02dQMfcK9AJlSVEfNr4cyL0fhl6LHlGIe917g/exec';
        let wordBank = [];
        let currentFlashcardIndex = 0;
        let quizWords = [];
        let currentQuizWord = null;
        let sessionCompletedCount = 0;
        let totalQuizWords = 0;

        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            loadWordBank();
            // 綁定確認刪除事件
            confirmDeleteBtn.addEventListener('click', confirmDeleteWordBank);
            cancelDeleteBtn.addEventListener('click', closeDeleteModal);
        });

        // --- 核心功能 ---
        
        function showView(viewId) {
            views.forEach(view => {
                view.classList.remove('active');
            });
            document.getElementById(viewId).classList.add('active');
            // 如果切換到單字庫畫面，重新載入單字
            if (viewId === 'word-bank-view') {
                loadWordBank();
            }
        }

        async function loadWordBank() {
            try {
                const response = await fetch(webAppUrl);
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                const data = await response.json();
                wordBank = data.map(w => ({
                    ...w,
                    quizStage: w.quizStage || 1
                }));
                renderWordList();
            } catch (error) {
                console.error("Failed to load word bank:", error);
                showToast('無法載入單字庫，請檢查網路連線或 API 設定', 'wrong');
                wordBank = [];
                renderWordList();
            }
        }
        
        function showToast(message, type = 'correct') {
            toastMessage.textContent = message;
            toastMessage.className = `toast show ${type === 'correct' ? 'toast-correct' : 'toast-wrong'}`;
            setTimeout(() => {
                toastMessage.classList.remove('show');
            }, 2000);
        }

        // --- 單字庫管理 ---

        function renderWordList() {
            wordList.innerHTML = '';
            if (wordBank.length === 0) {
                wordList.innerHTML = '<p class="text-center text-gray-500">您的單字庫是空的，快去新增一些單字吧！</p>';
                return;
            }
            wordBank.forEach((item, index) => {
                const wordElement = document.createElement('div');
                wordElement.className = 'flex items-center justify-between p-4 bg-white rounded-lg border border-gray-200 shadow-sm';
                wordElement.innerHTML = `
                    <div>
                        <p class="font-semibold text-lg text-gray-800">${item.word}</p>
                        <p class="text-gray-500">${item.translation}</p>
                    </div>
                    <button onclick="deleteWord('${item.word}')" class="text-red-500 hover:text-red-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                    </button>
                `;
                wordList.appendChild(wordElement);
            });
        }

        async function addWordManually() {
            const word = manualWordInput.value.trim().toLowerCase();
            const translation = manualTranslationInput.value.trim();
            if (!word || !translation) {
                showToast('請務必填寫英文單字和中文翻譯', 'wrong');
                return;
            }

            const payload = {
                action: 'addWord',
                word: word,
                translation: translation,
                quizStage: 1
            };

            try {
                const response = await fetch(webAppUrl, {
                    method: 'POST',
                    body: JSON.stringify(payload),
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                const result = await response.json();
                if (result.status === 'success') {
                    await loadWordBank();
                    manualWordInput.value = '';
                    manualTranslationInput.value = '';
                    showToast('新增成功！');
                } else {
                    showToast(result.message, 'wrong');
                }
            } catch (error) {
                console.error("Add word error:", error);
                showToast('新增單字時發生錯誤', 'wrong');
            }
        }

        async function importFromPaste() {
            const pasteArea = document.getElementById('paste-input');
            const text = pasteArea.value.trim();
            if (!text) {
                showToast('請先貼上單字列表', 'wrong');
                return;
            }

            const lines = text.split('\n');
            const newWords = [];
            const regex = /^([a-zA-Z\s]+?)\s*(\(.*\))\s*(.*)$/;

            for (const line of lines) {
                const trimmedLine = line.trim();
                if (!trimmedLine) continue;

                const match = trimmedLine.match(regex);
                if (match) {
                    const word = match[1].trim().toLowerCase();
                    const translation = `${match[2]} ${match[3]}`.trim();
                    newWords.push({ word, translation, quizStage: 1 });
                }
            }

            if (newWords.length === 0) {
                showToast('沒有找到可匯入的新單字，請檢查格式', 'wrong');
                return;
            }

            const payload = {
                action: 'addMultipleWords', // 假設您在 Apps Script 有處理多個單字的函式
                words: newWords
            };

            // 為了簡化，這裡改為一個個呼叫 API 新增，如果單字量大，建議 Apps Script 腳本也進行批次處理
            let addedCount = 0;
            for (const item of newWords) {
                const addPayload = {
                    action: 'addWord',
                    word: item.word,
                    translation: item.translation,
                    quizStage: 1
                };
                try {
                    const response = await fetch(webAppUrl, {
                        method: 'POST',
                        body: JSON.stringify(addPayload),
                        headers: { 'Content-Type': 'application/json' }
                    });
                    const result = await response.json();
                    if (result.status === 'success') {
                        addedCount++;
                    }
                } catch (error) {
                    console.error("Import error:", error);
                }
            }
            
            await loadWordBank();
            showToast(`成功匯入 ${addedCount} 個新單字！`);
            pasteArea.value = '';
        }

        async function translateAndFillManualInput() {
            const word = manualWordInput.value.trim().toLowerCase();
            if (!word) {
                showToast('請先輸入一個英文單字', 'wrong');
                return;
            }

            const translateBtn = document.getElementById('translate-manual-btn');
            const originalBtnText = translateBtn.textContent;
            translateBtn.textContent = '翻譯中...';
            translateBtn.disabled = true;

            try {
                const results = await translateWords([word]);
                if (results && results.length > 0 && results[0].translation !== '翻譯失敗') {
                    manualTranslationInput.value = results[0].translation;
                } else {
                    showToast('翻譯失敗，請檢查單字或稍後再試', 'wrong');
                    manualTranslationInput.value = '';
                }
            } catch (error) {
                console.error("Manual translation error:", error);
                showToast('翻譯時發生錯誤', 'wrong');
            } finally {
                translateBtn.textContent = originalBtnText;
                translateBtn.disabled = false;
            }
        }

        async function deleteWord(word) {
            const payload = {
                action: 'deleteWord',
                word: word
            };
            try {
                const response = await fetch(webAppUrl, {
                    method: 'POST',
                    body: JSON.stringify(payload),
                    headers: { 'Content-Type': 'application/json' }
                });
                const result = await response.json();
                if (result.status === 'success') {
                    await loadWordBank();
                    showToast('刪除成功！');
                } else {
                    showToast('刪除失敗', 'wrong');
                }
            } catch (error) {
                console.error("Delete word error:", error);
                showToast('刪除單字時發生錯誤', 'wrong');
            }
        }
        
        function openDeleteModal() {
            deleteConfirmModal.classList.remove('hidden');
        }

        function closeDeleteModal() {
            deleteConfirmModal.classList.add('hidden');
        }

        async function confirmDeleteWordBank() {
            const payload = { action: 'clearAll' };
            try {
                const response = await fetch(webAppUrl, {
                    method: 'POST',
                    body: JSON.stringify(payload),
                    headers: { 'Content-Type': 'application/json' }
                });
                const result = await response.json();
                if (result.status === 'success') {
                    await loadWordBank();
                    closeDeleteModal();
                    showToast('單字庫已成功刪除');
                } else {
                    showToast('清空單字庫失敗', 'wrong');
                }
            } catch (error) {
                console.error("Clear word bank error:", error);
                showToast('清空單字庫時發生錯誤', 'wrong');
            }
        }

        // --- 圖片辨識 (OCR) ---
        
        async function recognizeWordsFromImage(event) {
            const file = event.target.files[0];
            if (!file) return;

            ocrStatus.innerHTML = '<div class="loader mx-auto"></div><p class="mt-2">正在辨識圖片中的單字... (初次使用可能需下載模型)</p>';
            ocrResultsContainer.classList.add('hidden');
            
            try {
                const worker = await Tesseract.createWorker('eng');
                const { data: { text } } = await worker.recognize(file);
                await worker.terminate();

                const words = text.toLowerCase().replace(/['’]/g, '').match(/[a-z]{3,}/g) || [];
                const uniqueWords = [...new Set(words)];

                if (uniqueWords.length > 0) {
                    ocrStatus.textContent = `辨識完成 ${uniqueWords.length} 個單字，正在翻譯...`;
                    const translatedResults = await translateWords(uniqueWords);
                    displayOcrResults(translatedResults);
                    ocrStatus.textContent = `翻譯完成！請檢視並加入單字庫。`;
                } else {
                    ocrStatus.textContent = '辨識完成，但未找到可辨識的英文單字。';
                }

            } catch (error) {
                console.error("OCR or Translation Error:", error);
                ocrStatus.textContent = '辨識或翻譯失敗，請稍後再試。';
            }
        }

        async function translateWords(words) {
            const apiKey = ""; // Provided by the environment
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const prompt = `Translate the following English words to Traditional Chinese. Respond with only a valid JSON array of objects, where each object has a "word" key (the original English word in lowercase) and a "translation" key (the Chinese translation). Do not include any other text or explanations. The original word list is: ${JSON.stringify(words)}`;
            
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                "word": { "type": "STRING", "description": "The original English word." },
                                "translation": { "type": "STRING", "description": "The Traditional Chinese translation." }
                            },
                            required: ["word", "translation"]
                        }
                    }
                }
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) { throw new Error(`API call failed with status: ${response.status}`); }

                const result = await response.json();
                const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (jsonText) {
                    const parsedJson = JSON.parse(jsonText);
                    return words.map(originalWord => {
                        const found = parsedJson.find(item => item.word.toLowerCase() === originalWord.toLowerCase());
                        return {
                            word: originalWord,
                            translation: found ? found.translation : '翻譯失敗'
                        };
                    });
                }
                throw new Error("Invalid response structure from translation API");
            } catch (error) {
                console.error("Error during translation:", error);
                return words.map(word => ({ word, translation: '翻譯失敗' }));
            }
        }
        
        function displayOcrResults(results) {
            ocrResults.innerHTML = '';
            results.forEach(item => {
                if (wordBank.some(bankItem => bankItem.word === item.word)) {
                    return;
                }
                
                const resultElement = document.createElement('div');
                resultElement.className = 'grid grid-cols-1 md:grid-cols-3 gap-2 items-center';
                resultElement.innerHTML = `
                    <div class="flex items-center">
                        <input type="checkbox" class="h-5 w-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 mr-3" data-word="${item.word}" checked>
                        <label class="font-medium text-gray-700">${item.word}</label>
                    </div>
                    <input type="text" placeholder="請輸入中文翻譯" class="ocr-translation-input col-span-2 p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500" value="${item.translation}">
                `;
                ocrResults.appendChild(resultElement);
            });
            
            if (ocrResults.children.length > 0) {
                 ocrResultsContainer.classList.remove('hidden');
            } else {
                 ocrResultsContainer.classList.add('hidden');
                 if (ocrStatus.textContent.includes('辨識完成')) {
                    ocrStatus.textContent = '辨識完成，但未找到可加入的新單字。';
                }
            }
        }
        
        async function addSelectedWordsFromOCR() {
            const selectedCheckboxes = ocrResults.querySelectorAll('input[type="checkbox"]:checked');
            let addedCount = 0;

            for (const checkbox of selectedCheckboxes) {
                const word = checkbox.dataset.word;
                const translationInput = checkbox.closest('.grid').querySelector('.ocr-translation-input');
                const translation = translationInput.value.trim();

                if (translation && !wordBank.some(item => item.word === word)) {
                    const payload = {
                        action: 'addWord',
                        word: word,
                        translation: translation,
                        quizStage: 1
                    };
                    try {
                        const response = await fetch(webAppUrl, {
                            method: 'POST',
                            body: JSON.stringify(payload),
                            headers: { 'Content-Type': 'application/json' }
                        });
                        const result = await response.json();
                        if (result.status === 'success') {
                            addedCount++;
                        }
                    } catch (error) {
                        console.error("OCR import error:", error);
                    }
                }
            }
            
            if (addedCount > 0) {
                await loadWordBank();
                showToast(`成功加入 ${addedCount} 個單字！`);
                ocrResultsContainer.classList.add('hidden');
                ocrStatus.textContent = '';
            } else {
                showToast('請先勾選單字並填寫翻譯', 'wrong');
            }
        }
        
        // --- 單字卡模式 ---

        function startFlashcardMode() {
            if (wordBank.length === 0) {
                showToast('您的單字庫是空的，請先新增單字', 'wrong');
                return;
            }
            currentFlashcardIndex = 0;
            updateFlashcard();
            showView('flashcard-view');
        }

        function updateFlashcard() {
            const item = wordBank[currentFlashcardIndex];
            flashcardWord.textContent = item.word;
            flashcardTranslation.textContent = item.translation;
            flashcardProgress.textContent = `${currentFlashcardIndex + 1} / ${wordBank.length}`;
            document.getElementById('flashcard').classList.remove('is-flipped');
        }

        function nextFlashcard() {
            currentFlashcardIndex = (currentFlashcardIndex + 1) % wordBank.length;
            updateFlashcard();
        }

        function prevFlashcard() {
            currentFlashcardIndex = (currentFlashcardIndex - 1 + wordBank.length) % wordBank.length;
            updateFlashcard();
        }

        function speakFlashcardWord() {
            const word = wordBank[currentFlashcardIndex].word;
            speak(word);
        }
        
        // --- 語音合成 ---
        
        function speak(text) {
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'en-US';
            window.speechSynthesis.speak(utterance);
        }
        
        // --- 測驗模式 ---

        function startQuizMode() {
            if (wordBank.length === 0) {
                showToast('您的單字庫是空的，請先新增單字', 'wrong');
                return;
            }
            totalQuizWords = wordBank.length;
            sessionCompletedCount = 0;
            quizWords = [...wordBank]
                .map(w => ({ ...w, stage: w.quizStage }))
                .sort(() => Math.random() - 0.5);
            
            nextQuizWord();
            showView('quiz-view');
        }

        function nextQuizWord() {
            if (quizWords.length === 0) {
                quizFeedback.textContent = '';
                quizInput.value = '';
                quizProgress.textContent = `測驗完成！您總共答對了 ${sessionCompletedCount} 個單字。`;
                return;
            }
            
            currentQuizWord = quizWords.shift();
            speak(currentQuizWord.word);
            
            quizInput.value = '';
            quizInput.focus();
            quizFeedback.textContent = '';
            quizSubmitBtn.textContent = '送出';
            quizProgress.textContent = `進度：${sessionCompletedCount} / ${totalQuizWords}`;
        }
        
        async function checkQuizAnswer() {
            if (!currentQuizWord) return;
            
            const userAnswer = quizInput.value.trim().toLowerCase();
            const correctAnswer = currentQuizWord.word.toLowerCase();
            
            if (userAnswer === correctAnswer) {
                quizFeedback.textContent = '正確！';
                quizFeedback.className = 'mt-4 text-xl font-semibold text-green-600 h-8';
                
                // 更新 quizStage，並將變更寫回 Google Sheet
                currentQuizWord.quizStage++;
                await updateQuizStage(currentQuizWord.word, currentQuizWord.quizStage);
                
                sessionCompletedCount++;
                setTimeout(() => nextQuizWord(), 1000);
            } else {
                quizFeedback.textContent = `錯誤，正確答案是：${currentQuizWord.word}`;
                quizFeedback.className = 'mt-4 text-xl font-semibold text-red-600 h-8';
                
                // 如果答錯，將單字放回隊伍中，增加下次練習機會
                quizWords.push(currentQuizWord);
                
                // 不延遲，讓使用者可以再次嘗試或看答案
                quizSubmitBtn.textContent = '再試一次';
            }
        }
        
        async function updateQuizStage(word, newStage) {
            const payload = {
                action: 'updateWord',
                word: word,
                newQuizStage: newStage
            };
            try {
                const response = await fetch(webAppUrl, {
                    method: 'POST',
                    body: JSON.stringify(payload),
                    headers: { 'Content-Type': 'application/json' }
                });
                const result = await response.json();
                if (result.status !== 'success') {
                    console.error('Failed to update quiz stage:', result.message);
                }
            } catch (error) {
                console.error("Update quiz stage error:", error);
            }
        }

        quizInput.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                checkQuizAnswer();
            }
        });
    </script>
</body>
</html>





